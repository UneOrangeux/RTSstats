<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TT RTS Leaderboard – Minimal v2</title>
<style>
  body{font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#0b1220;color:#e6edf3}
  .wrap{max-width:920px;margin:0 auto;padding:20px}
  .card{background:#0f1629;border:1px solid #1f2a44;border-radius:14px;padding:14px;margin-bottom:14px}
  h1{font-size:20px;margin:0 0 8px}
  label{font-size:12px;color:#9fb3c8}
  input{width:100%;padding:8px 10px;border-radius:10px;border:1px solid #233053;background:#0b1220;color:#e6edf3}
  .row{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  button{border:none;border-radius:10px;padding:10px 12px;background:#2f6feb;color:#fff;font-weight:700;cursor:pointer}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{border-bottom:1px solid #1f2a44;padding:8px 6px;text-align:left}
  th{color:#9fb3c8;text-transform:uppercase;font-size:11px;letter-spacing:.03em}
  .muted{color:#9fb3c8}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .status{font-size:12px;color:#9fb3c8}
  .buttons{display:flex;gap:8px;align-items:flex-end}
  pre{white-space:pre-wrap}
</style>
</head>
<body>
<div class="wrap">
  <h1>TT RTS Leaderboard</h1>
  <div class="card">
    <div class="row2">
      <div>
        <label>Private API Key</label>
        <input id="apiKey" placeholder="X-Tycoon-Key">
      </div>
      <div>
        <label>Public Key (optional)</label>
        <input id="pubKey" placeholder="X-Tycoon-Public-Key">
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <div>
        <label>Min streak</label>
        <input id="minStreak" type="number" value="0">
      </div>
      <div>
        <label>Max streak</label>
        <input id="maxStreak" type="number" placeholder="(none)">
      </div>
      <div>
        <label>Request limit</label>
        <input id="limit" type="number" value="50">
      </div>
      <div class="buttons">
        <button type="button" id="refreshBtn">Refresh</button>
        <button type="button" id="testBtn" title="Quick JS test">Test</button>
      </div>
    </div>
    <details style="margin-top:10px">
      <summary class="muted">Advanced (only change if needed)</summary>
      <div class="row" style="margin-top:8px">
        <div>
          <label>API Base</label>
          <input id="apiBase" value="https://v1.api.tycoon.community">
        </div>
        <div>
          <label>Streak Path</label>
          <input id="streakPath" value="/main/streak/{vrpId}">
        </div>
        <div>
          <label>Servers JSON</label>
          <input id="serversJson" value="https://cdn.tycoon.community/servers.json">
        </div>
        <div>
          <label>Use Proxy (optional)</label>
          <input id="proxyUrl" placeholder="http://127.0.0.1:8787 (if CORS blocked)">
        </div>
      </div>
    </details>
    <div class="status" id="status" style="margin-top:8px">Ready.</div>
    <pre id="log" class="muted mono" style="margin-top:8px;max-height:120px;overflow:auto"></pre>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="status" id="count">0 players</div>
      <input id="filter" placeholder="Filter by name or vRP id…" style="max-width:260px">
    </div>
    <div style="overflow-x:auto;margin-top:6px">
      <table id="table">
        <thead>
          <tr><th>Rank</th><th>vRP ID</th><th>Name</th><th>RTS Streak</th><th class="muted">Locked/Err</th><th class="muted mono">Server</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card muted">
    Each API call costs 1 charge on your private key. Start with a small Request limit.
    If you see “CORS” errors, run a tiny proxy:

    <pre class="mono">npm init -y
npm i express node-fetch
node proxy.js</pre>
  </div>
</div>

<script defer>
(function(){
  const $ = (id) => document.getElementById(id);
  const state = { rows: [] };
  const logEl = $("#log");
  function log(...args){ const msg = args.join(" "); logEl.textContent += msg + "\n"; console.log(...args); }
  function setStatus(s){ $("#status").textContent = s; log(s); }

  function headers(){
    const h = { "X-Tycoon-Key": $("#apiKey").value.trim() };
    const p = $("#pubKey").value.trim();
    if (p) h["X-Tycoon-Public-Key"] = p;
    return h;
  }

  async function fetchJSON(url, opts){
    log("GET", url);
    const res = await fetch(url, opts);
    log("...status", res.status);
    if(!res.ok) throw new Error(res.status+" "+res.statusText);
    return res.json();
  }

  function parsePlayersFromWidget(json){
    const out = [];
    const dig = (obj)=>{
      if(!obj) return;
      if(Array.isArray(obj)){
        obj.forEach(p=>{
          const id = p.id || p.vrp || p.vRP || p.vrp_id || p.netId;
          if(id!=null) out.push({id:String(id), name: p.name || p.playerName || p.PlayerName || "Unknown"});
        });
        return;
      }
      if(Array.isArray(obj.players)){
        obj.players.forEach(p=>{
          const id = p.id || p.vrp || p.vRP || p.vrp_id || p.netId;
          if(id!=null) out.push({id:String(id), name: p.name || p.playerName || p.PlayerName || "Unknown"});
        });
        return;
      }
      if(typeof obj==="object"){
        Object.values(obj).forEach(v=>dig(v));
      }
    };
    dig(json);
    return out;
  }

  function render(){
    const tbody = $("#table").querySelector("tbody");
    const t = ($("#filter").value||"").toLowerCase();
    const rows = state.rows
      .filter(r => !t || (r.name||"").toLowerCase().includes(t) || (r.id||"").includes(t))
      .sort((a,b)=>(b.streak??-1)-(a.streak??-1));

    $("#count").textContent = rows.length+" players";
    tbody.innerHTML = rows.map((r,i)=>`<tr>
      <td>${i+1}</td>
      <td class="mono">${r.id}</td>
      <td>${r.name||""}</td>
      <td><b>${r.streak ?? "—"}</b></td>
      <td class="muted">${r.locked?"locked":(r.error||"")}</td>
      <td class="muted mono">${r.serverHint||""}</td>
    </tr>`).join("");
  }

  async function build(){
    try{
      const key = $("#apiKey").value.trim();
      if(!key){ alert("Enter your Private API key"); return; }
      localStorage.setItem("tt_key", key);
      localStorage.setItem("tt_pub", $("#pubKey").value.trim());

      setStatus("Discovering servers…");
      const base = $("#apiBase").value.trim();
      const path = $("#streakPath").value.trim();
      const serversJson = $("#serversJson").value.trim();
      const proxy = $("#proxyUrl").value.trim();
      const limit = parseInt($("#limit").value||"50",10);
      const minS = parseInt($("#minStreak").value||"0",10);
      const maxS = parseInt($("#maxStreak").value||"999999999",10);

      const srvUrl = proxy ? proxy + "/servers.json" : serversJson;
      const servers = await fetchJSON(srvUrl);
      const list = Array.isArray(servers?.servers) ? servers.servers : Array.isArray(servers) ? servers : [];
      const widgetUrls = [];
      list.forEach(s=>{
        const p = s?.endpoints?.players || s?.players || s?.widget || s?.player_widget;
        if(typeof p === "string") widgetUrls.push(p);
      });
      const seen = new Map();
      for(const w of widgetUrls){
        try{
          const url = proxy ? proxy + "/widget/" + w.replace(/^https?:\/\//,'') : w;
          const json = await fetchJSON(url);
          const players = parsePlayersFromWidget(json);
          players.forEach(p=>{ if(!seen.has(p.id)) seen.set(p.id, {...p, serverHint: w}); });
        }catch(e){ log("widget fail", w, e.message); }
      }
      const all = Array.from(seen.values()).slice(0, limit);
      if(all.length===0){ setStatus("No players discovered."); state.rows=[]; render(); return; }

      setStatus("Querying streaks for "+all.length+" players…");
      const out = [];
      for(const p of all){
        const url = (proxy? proxy: base) + path.replace("{vrpId}", encodeURIComponent(p.id));
        try{
          const data = await fetchJSON(url, { headers: headers() });
          if(data && data.error === "locked"){
            out.push({...p, streak:null, locked:true});
          } else {
            const s = data?.streak ?? data?.rts?.streak ?? data?.value ?? null;
            if(s!=null && s>=minS && s<=maxS){
              out.push({...p, streak:s});
            } else if(s==null){
              out.push({...p, streak:null});
            }
          }
        }catch(e){
          const msg = String(e.message||"error");
          if(/CORS|cors|blocked|Access-Control/i.test(msg)){
            setStatus("CORS blocked. Set a proxy URL (see Advanced).");
            out.push({...p, streak:null, error:"CORS"});
          } else {
            out.push({...p, streak:null, error:msg});
          }
        }
      }
      state.rows = out;
      render();
      setStatus("Done.");
    }catch(err){
      setStatus("Error: "+err.message);
      log("Error", err);
    }
  }

  // Wire up
  $("#apiKey").value = localStorage.getItem("tt_key")||"";
  $("#pubKey").value = localStorage.getItem("tt_pub")||"";
  $("#refreshBtn").addEventListener("click", build);
  $("#testBtn").addEventListener("click", ()=> setStatus("Button works ✔"));
  $("#filter").addEventListener("input", render);

  // Optional: auto-run once if key exists
  if($("#apiKey").value){ setTimeout(()=>{ build(); }, 500); }
})();</script>
</body>
</html>
